<!DOCTYPE html>
<html>

<head>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119235055-1"></script>
  <script>
    if (window.location.hostname === "localhost") {
      console.log("Analytics not running on local dev.");
    } else {
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'UA-119235055-1');
    }
  </script>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> Get ESXi Host CDP Info With PowerCLI</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />

  
  <link rel="stylesheet" type="text/css" href="/css/custom/screen-custom.css" />
  <link rel="stylesheet" type="text/css" href="/css/fontawesome_all.min.css" />
  <link rel="stylesheet" type="text/css" href="/css/prism.css" />
  <link rel="stylesheet" type="text/css" href="/css/custom/prism-custom.css" />
  <link rel="stylesheet" type="text/css" href="/css/custom/global-custom.css" />

  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,500,600,700" rel="stylesheet">

  
  <script data-ad-client="ca-pub-8907477009760148" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:creator" content="@_ryanjan_">
<meta name="twitter:site" content="@_ryanjan_">

<meta property="og:title" content="Get ESXi Host CDP Info With PowerCLI">
<meta property="og:description" content="I recently had to provide our networking team with a list of ESXi hosts and which switchports each of their physical NICs were connected to. Like many other environments, we are primarily a Cisco house and therefore I was able to get this data by querying the Cisco Discovery Protocol (CDP) information via PowerCLI. Here is how I went about it.">
<meta property="og:url" content="https://ryanjan.uk/get-host-cdp-info-with-powercli/">

    
    <meta property="og:image" content="https://ryanjan.uk/images/2019/02/cisco-logo-16x9-2-1.jpg">
    


</head>





<body class='post-template' >
  <div class="viewport">
    <header id="gh-head" class="gh-head">
      <nav class="gh-head-inner inner gh-container">

        <div class="gh-head-brand">
          <a class="gh-head-logo" href="/">
            <img src="/images/favicon.png" />
          </a>
          <a class="gh-burger" role="button">
            <div class="gh-burger-box">
              <div class="gh-burger-inner"></div>
            </div>
          </a>
        </div>
        <div class="gh-head-menu">
          <ul class="nav">
    <li class="nav-home nav-current"><a href="/">Home</a></li>
    <li class="nav-about"><a href="/about/">About</a></li>
</ul>
        </div>
        <div class="gh-head-actions">
          <div class="gh-social">
            <a class="gh-social-github" href="https://github.com/ryan-jan" title="GitHub" target="_blank"
              rel="noopener">
              <i class="fab fa-github fa-lg"></i>
            </a>
            <a class="gh-social-twitter" href="https://twitter.com/_ryanjan_" title="Twitter" target="_blank"
              rel="noopener">
              <i class="fab fa-twitter fa-lg"></i>
            </a>
          </div>
          <a class="gh-head-button su-modal-open-button" href="#/subscribe">Subscribe</a>
        </div>
      </nav>
    </header>
    <main>
      
<article class="article">
    <header class="article-header gh-canvas">
        
        
        
        <section class="article-tag">
            <a href="/tags/powercli">powercli</a>
        </section>
        
        

        <h1 class="article-title">Get ESXi Host CDP Info With PowerCLI</h1>

        

        <div class="article-byline">
            <section class="article-byline-content">
                
                
                
                
                
                
                <ul class="author-list">
                    <li class="author-list-item">
                        
                        <a href="https://ryanjan.uk/authors/ryan/" class="author-avatar">
                            
                            <img class="author-profile-image" src="/authors/ryan/avatar_hu2133b973be59ca79693e44e4bc908b85_51876_60x60_fill_q75_box_center.jpg" />
                        </a>
                    </li>
                </ul>
                <div class="article-byline-meta">
                    <h4 class="author-name"><a href="https://ryanjan.uk/authors/ryan/">Ryan Kowalewski</a></h4>
                    <div class="byline-meta-content">
                        10 Feb 2019
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 6 min
                            read</span>
                    </div>
                </div>
                
                
                
            </section>
        </div>

        
            
            <figure class="article-image">
                <img src="/images/2019/02/cisco-logo-16x9-2-1.jpg" alt="Get ESXi Host CDP Info With PowerCLI" />
            </figure>
            
        
    </header>

    <section class="gh-content gh-canvas">
        <h2 id="introduction">Introduction</h2>
<p>I recently had to provide our networking team with a list of ESXi hosts and which switchports each of their physical NICs were connected to. Like many other environments, we are primarily a Cisco house and therefore I was able to get this data by querying the Cisco Discovery Protocol (CDP) information via PowerCLI. Here is how I went about it.</p>
<h2 id="the-process">The Process</h2>
<p>I will initially show you how to pull this information for a specific host. However, later in the post I will show you a helpful script that I put together to pull this information for multiple hosts based on host or cluster name.</p>
<div class="in-article-ad">
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
     <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article"
          data-ad-format="fluid" data-ad-client="ca-pub-8907477009760148" data-ad-slot="3921250676"></ins>
     <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
     </script>
</div>
<p>The first thing to do is connect to your vCenter server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Connect-VIServer vcenter.example.com
</span></span></code></pre></div><p>Next, get a specific host object and store it in the <code>$VMHost</code> variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$VMHost = Get-VMHost -Name esxi01.example.com
</span></span></code></pre></div><p>The CDP information is actually found within the <code>NetworkSystem</code> managed object of the <code>HostConfigManager</code> object. This can be accessed using the <code>Get-View</code> CmdLet as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$NetSystem = Get-View $VMHost.ExtensionData.ConfigManager.NetworkSystem
</span></span></code></pre></div><p>If you pipe the <code>$NetSystem</code> object to the <code>Get-Member</code> CmdLet you should see something similar to this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$NetSystem | Get-Member
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   TypeName<span style="color:#960050;background-color:#1e0010">:</span> VMware.Vim.HostNetworkSystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name                            MemberType Definition
</span></span><span style="display:flex;"><span>----                            ---------- ----------
</span></span><span style="display:flex;"><span>AddPortGroup                    Method     void AddPortGroup(VMware.Vim.HostPortGroupSpec portgrp)
</span></span><span style="display:flex;"><span>AddServiceConsoleVirtualNic     Method     string AddServiceConsoleVirtualNic(string portgroup, VMware.Vim.HostVirtualNicSpec nic)
</span></span><span style="display:flex;"><span>AddVirtualNic                   Method     string AddVirtualNic(string portgroup, VMware.Vim.HostVirtualNicSpec nic)
</span></span><span style="display:flex;"><span>AddVirtualSwitch                Method     void AddVirtualSwitch(string vswitchName, VMware.Vim.HostVirtualSwitchSpec spec)
</span></span><span style="display:flex;"><span>Equals                          Method     bool Equals(System.Object obj)
</span></span><span style="display:flex;"><span>GetHashCode                     Method     int GetHashCode()
</span></span><span style="display:flex;"><span>GetType                         Method     type GetType()
</span></span><span style="display:flex;"><span>QueryNetworkHint                Method     VMware.Vim.PhysicalNicHintInfo[] QueryNetworkHint(string[] device)
</span></span><span style="display:flex;"><span>RefreshNetworkSystem            Method     void RefreshNetworkSystem()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>This displays all available methods and properties for this object. The method that we are going to use is <code>QueryNetworkHint</code>. To find out the arguments that this method requires you can run the method on its own.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$NetSystem.QueryNetworkHint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OverloadDefinitions
</span></span><span style="display:flex;"><span>-------------------
</span></span><span style="display:flex;"><span>VMware.Vim.PhysicalNicHintInfo[] QueryNetworkHint(string[] device)
</span></span></code></pre></div><p>We can see that the <code>QueryNetworkHint</code> method requires a single argument, which is an individual physical network device for the host. Helpfully, this information is readily available in our <code>$VMHost</code> variable from earlier. Running the following will list all physical devices for the specific host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$VMHost.ExtensionData.Config.Network.Pnic
</span></span></code></pre></div><p>With these two pieces of information we are able to loop through each physical network device and run the <code>QueryNetworkHint</code> method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($Pnic <span style="color:#66d9ef">in</span> $VMHost.ExtensionData.Config.Network.Pnic) {
</span></span><span style="display:flex;"><span>    $NetSystem.QueryNetworkHint($Pnic.Device)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device              <span style="color:#960050;background-color:#1e0010">:</span> vmnic5
</span></span><span style="display:flex;"><span>Subnet              <span style="color:#960050;background-color:#1e0010">:</span> {<span style="color:#ae81ff">3506</span>, <span style="color:#ae81ff">3505</span>}
</span></span><span style="display:flex;"><span>Network             <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>ConnectedSwitchPort <span style="color:#960050;background-color:#1e0010">:</span> VMware.Vim.PhysicalNicCdpInfo
</span></span><span style="display:flex;"><span>LldpInfo            <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device              <span style="color:#960050;background-color:#1e0010">:</span> vmnic6
</span></span><span style="display:flex;"><span>Subnet              <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>Network             <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>ConnectedSwitchPort <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>LldpInfo            <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device              <span style="color:#960050;background-color:#1e0010">:</span> vmnic7
</span></span><span style="display:flex;"><span>Subnet              <span style="color:#960050;background-color:#1e0010">:</span> {<span style="color:#ae81ff">3506</span>, <span style="color:#ae81ff">3505</span>}
</span></span><span style="display:flex;"><span>Network             <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>ConnectedSwitchPort <span style="color:#960050;background-color:#1e0010">:</span> VMware.Vim.PhysicalNicCdpInfo
</span></span><span style="display:flex;"><span>LldpInfo            <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Looking at that output we can see that the information we are interested in is in the <code>ConnectedSwitchPort</code> property. I can expand the <code>foreach</code> loop as follows to get this information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($Pnic <span style="color:#66d9ef">in</span> $VMHost.ExtensionData.Config.Network.Pnic) {
</span></span><span style="display:flex;"><span>    $PnicInfo = $NetSystem.QueryNetworkHint($Pnic.Device)
</span></span><span style="display:flex;"><span>    $PnicInfo.ConnectedSwitchPort
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CdpVersion       <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Timeout          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>Ttl              <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">137</span>
</span></span><span style="display:flex;"><span>Samples          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">21334</span>
</span></span><span style="display:flex;"><span>DevId            <span style="color:#960050;background-color:#1e0010">:</span> N5K_1
</span></span><span style="display:flex;"><span>Address          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.222</span>.0.236
</span></span><span style="display:flex;"><span>PortId           <span style="color:#960050;background-color:#1e0010">:</span> Ethernet108/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>DeviceCapability <span style="color:#960050;background-color:#1e0010">:</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>SoftwareVersion  <span style="color:#960050;background-color:#1e0010">:</span> Cisco Nexus Operating System (NX-OS) Software, Version <span style="color:#ae81ff">7.0</span>(<span style="color:#ae81ff">7</span>)N1(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>HardwarePlatform <span style="color:#960050;background-color:#1e0010">:</span> N5K-C5596UP
</span></span><span style="display:flex;"><span>IpPrefix         <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0.0</span>.0.0
</span></span><span style="display:flex;"><span>IpPrefixLen      <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Vlan             <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FullDuplex       <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>Mtu              <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>SystemName       <span style="color:#960050;background-color:#1e0010">:</span> N5K_1
</span></span><span style="display:flex;"><span>SystemOID        <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1.3</span>.6.1.4.1.9.12.3.1.3.1038
</span></span><span style="display:flex;"><span>MgmtAddr         <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.123</span>.96.141
</span></span><span style="display:flex;"><span>Location         <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CdpVersion       <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Timeout          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>Ttl              <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">148</span>
</span></span><span style="display:flex;"><span>Samples          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">21334</span>
</span></span><span style="display:flex;"><span>DevId            <span style="color:#960050;background-color:#1e0010">:</span> N5K_2
</span></span><span style="display:flex;"><span>Address          <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.222</span>.0.235
</span></span><span style="display:flex;"><span>PortId           <span style="color:#960050;background-color:#1e0010">:</span> Ethernet108/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>DeviceCapability <span style="color:#960050;background-color:#1e0010">:</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>SoftwareVersion  <span style="color:#960050;background-color:#1e0010">:</span> Cisco Nexus Operating System (NX-OS) Software, Version <span style="color:#ae81ff">7.0</span>(<span style="color:#ae81ff">7</span>)N1(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>HardwarePlatform <span style="color:#960050;background-color:#1e0010">:</span> N5K-C5596UP
</span></span><span style="display:flex;"><span>IpPrefix         <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0.0</span>.0.0
</span></span><span style="display:flex;"><span>IpPrefixLen      <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Vlan             <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FullDuplex       <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>Mtu              <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>SystemName       <span style="color:#960050;background-color:#1e0010">:</span> N5K_2
</span></span><span style="display:flex;"><span>SystemOID        <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1.3</span>.6.1.4.1.9.12.3.1.3.1038
</span></span><span style="display:flex;"><span>MgmtAddr         <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.123</span>.96.142
</span></span><span style="display:flex;"><span>Location         <span style="color:#960050;background-color:#1e0010">:</span>
</span></span></code></pre></div><p>There is a lot of information available in this property, most of which I am not interested in. Also, it is not very helpful that I can&rsquo;t tell from this output which physical device (e.g. vmnic0) that each of these blocks of information relate to. To tidy this up we can create a new <code>PSCustomObject</code> in the <code>foreach</code> loop and return only the information we want to see.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($Pnic <span style="color:#66d9ef">in</span> $VMHost.ExtensionData.Config.Network.Pnic) {
</span></span><span style="display:flex;"><span>    $PnicInfo = $NetSystem.QueryNetworkHint($Pnic.Device)
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">PSCustomObject</span>] @{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Device&#39;</span> = $Pnic.Device
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;DevId&#39;</span> = $PnicInfo.ConnectedSwitchPort.DevId
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;PortId&#39;</span> = $PnicInfo.ConnectedSwitchPort.PortId
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device DevId                      PortId
</span></span><span style="display:flex;"><span>------ -----                      ------
</span></span><span style="display:flex;"><span>vmnic0
</span></span><span style="display:flex;"><span>vmnic1
</span></span><span style="display:flex;"><span>vmnic2
</span></span><span style="display:flex;"><span>vmnic3
</span></span><span style="display:flex;"><span>vmnic4
</span></span><span style="display:flex;"><span>vmnic5 N5K_1                      Ethernet108/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>vmnic6
</span></span><span style="display:flex;"><span>vmnic7 N5K_2                      Ethernet108/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">14</span>
</span></span></code></pre></div><div class="in-article-ad">
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
     <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article"
          data-ad-format="fluid" data-ad-client="ca-pub-8907477009760148" data-ad-slot="3921250676"></ins>
     <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
     </script>
</div>
<h2 id="a-helper-script">A Helper Script</h2>
<p>Now that we understand how we can get this information via PowerCLI, I want to show you a helper script/function that I have put together. This script enables us to target specific hosts by hostname or cluster name and also allows us to filter which physical NICs we are interested in. The script is available on <a href="https://github.com/ryan-jan/Blog-Scripts/blob/master/Get-VMHostCDPInfo.ps1">my GitHub</a>.</p>
<p>Once you have the script downloaded you will need to connect to your vCenter server before running it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Connect-VIServer -Server vcenter.example.com
</span></span></code></pre></div><p>Here are a few examples of how you can use this script, note that the script excludes any physical NICs which do not have CDP information available. First, lets get a single host&rsquo;s CDP information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Get-VMHostCDPInfo.ps1 -VMHost <span style="color:#e6db74">&#39;esxi01.example.com&#39;</span> | Format-Table
</span></span></code></pre></div><p>I am using <code>Format-Table</code> to present the large dataset in a more friendy way. Now lets get CDP information for all hosts in the cluster <code>Cluster01</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Get-VMHostCDPInfo.ps1 -Cluster <span style="color:#e6db74">&#39;Cluster01&#39;</span> | Format-Table -GroupBy VMHost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   VMHost<span style="color:#960050;background-color:#1e0010">:</span> esxi01.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost                Pnic   CdpVersion Timeout Ttl Samples DevId                      Address      PortId           DeviceCapability
</span></span><span style="display:flex;"><span>------                ----   ---------- ------- --- ------- -----                      -------      ------           ----------------
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic0          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">125</span>  <span style="color:#ae81ff">351248</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">30</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic1          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">124</span>  <span style="color:#ae81ff">351248</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">29</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic3          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">135</span>  <span style="color:#ae81ff">351249</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">27</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic4          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">163</span>  <span style="color:#ae81ff">351249</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">31</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic5          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">160</span>  <span style="color:#ae81ff">351249</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">30</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic7          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">160</span>  <span style="color:#ae81ff">351250</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet109/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">29</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   VMHost<span style="color:#960050;background-color:#1e0010">:</span> esxi02.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost                Pnic   CdpVersion Timeout Ttl Samples DevId                      Address      PortId           DeviceCapability
</span></span><span style="display:flex;"><span>------                ----   ---------- ------- --- ------- -----                      -------      ------           ----------------
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic0          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">143</span>  <span style="color:#ae81ff">346948</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">21</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic1          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">143</span>  <span style="color:#ae81ff">346948</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">20</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic3          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">165</span>  <span style="color:#ae81ff">346948</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">19</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic4          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">131</span>  <span style="color:#ae81ff">346947</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">21</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic5          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">170</span>  <span style="color:#ae81ff">346948</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">20</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic7          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">156</span>  <span style="color:#ae81ff">346948</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.230 Ethernet101/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">19</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span></code></pre></div><p>In this example I also used the <code>-GroupBy</code> parameter of <code>Format-Table</code> to display the information grouped by each host. Now lets get CDP information for both <code>esxi01.example.com</code> and <code>esxi02.example.com</code> but filter the results to show just <code>vmnic5</code> and <code>vmnic7</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Get-VMHostCDPInfo.ps1 -VMHost <span style="color:#e6db74">&#39;esxi01.example.com&#39;</span>, <span style="color:#e6db74">&#39;esxi02.exmple.com&#39;</span> -Vmnic <span style="color:#e6db74">&#39;vmnic5&#39;</span>, <span style="color:#e6db74">&#39;vmnic7&#39;</span> | Format-Table -GroupBy VMHost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   VMHost<span style="color:#960050;background-color:#1e0010">:</span> esxi01.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost                Pnic   CdpVersion Timeout Ttl Samples DevId                      Address      PortId           DeviceCapability
</span></span><span style="display:flex;"><span>------                ----   ---------- ------- --- ------- -----                      -------      ------           ----------------
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic5          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">155</span>  <span style="color:#ae81ff">436320</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet105/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">20</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi01.example.com    vmnic7          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">133</span>  <span style="color:#ae81ff">436320</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.231 Ethernet105/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">18</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   VMHost<span style="color:#960050;background-color:#1e0010">:</span> esxi02.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost                Pnic   CdpVersion Timeout Ttl Samples DevId                      Address      PortId          DeviceCapability
</span></span><span style="display:flex;"><span>------                ----   ---------- ------- --- ------- -----                      -------      ------          ----------------
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic5          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">121</span>  <span style="color:#ae81ff">341221</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.235 Ethernet102/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">7</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span><span style="display:flex;"><span>esxi02.example.com    vmnic7          <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">146</span>  <span style="color:#ae81ff">341222</span> N5K_5                      <span style="color:#ae81ff">10.222</span>.0.235 Ethernet102/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">6</span> VMware.Vim.PhysicalNicCdpDeviceCapability
</span></span></code></pre></div><p>And obviously you can use <code>Select-Object</code> to return only the columns that you require if you wish.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Get-VMHostCDPInfo.ps1 -VMHost <span style="color:#e6db74">&#39;esxi01.example.com&#39;</span> -Vmnic <span style="color:#e6db74">&#39;vmnic5&#39;</span>, <span style="color:#e6db74">&#39;vmnic7&#39;</span> | Select-Object VMhost, Pnic, DevId, Address, PortId
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost  <span style="color:#960050;background-color:#1e0010">:</span> esxi01.example.com
</span></span><span style="display:flex;"><span>Pnic    <span style="color:#960050;background-color:#1e0010">:</span> vmnic5
</span></span><span style="display:flex;"><span>DevId   <span style="color:#960050;background-color:#1e0010">:</span> N5K_5
</span></span><span style="display:flex;"><span>Address <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.222</span>.0.231
</span></span><span style="display:flex;"><span>PortId  <span style="color:#960050;background-color:#1e0010">:</span> Ethernet105/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VMHost  <span style="color:#960050;background-color:#1e0010">:</span> esxi01.example.com
</span></span><span style="display:flex;"><span>Pnic    <span style="color:#960050;background-color:#1e0010">:</span> vmnic7
</span></span><span style="display:flex;"><span>DevId   <span style="color:#960050;background-color:#1e0010">:</span> N5K_5
</span></span><span style="display:flex;"><span>Address <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.222</span>.0.231
</span></span><span style="display:flex;"><span>PortId  <span style="color:#960050;background-color:#1e0010">:</span> Ethernet105/<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">18</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>I hope you have found this post and the helper script useful. It really did come in handy for me when gathering this information for our network team recently!</p>
<div class="in-article-ad">
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
     <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article"
          data-ad-format="fluid" data-ad-client="ca-pub-8907477009760148" data-ad-slot="3921250676"></ins>
     <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
     </script>
</div>

    </section>

</article>

<section class="footer-cta">
    <div class="inner">
        <h2>Sign up for more like this.</h2>
        <a class="footer-cta-button su-modal-open-button" href="#/subscribe">
            <div>Enter your email</div>
            <span>Subscribe</span>
        </a>
    </div>
</section>

<aside class="read-more-wrap">
    <div class="read-more inner">
        
        
        
        <article class="post-card">

    
    
        <a class="post-card-image-link" href="https://ryanjan.uk/powershell-tips-script-optimization/">
            <img class="post-card-image" src="/images/2018/06/lum3n-193427-unsplash.jpg" loading="lazy" />
        </a>
    

    <div class="post-card-content">
        <a class="post-card-content-link" href="https://ryanjan.uk/powershell-tips-script-optimization/">
            <header class="post-card-header">
                
                
                
                <div class="post-card-primary-tag">powershell</div>
                
                
                <h2 class="post-card-title">PowerShell Tips: Script Optimization</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Introduction A colleague of mine recently asked for some help with a script he was writing. We use vSphere tags in order to determine which backup schedule a given VM is in and he wanted to find all VMs which were not assigned a tag in the category backup-service-level, and therefore were not being backed up. His actual query was regarding filtering out certain VMs which will never be given a backup tag.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            
            
            
            
            
            
            <ul class="author-list">
                <li class="author-list-item">
                    
                    <a href="https://ryanjan.uk/authors/ryan/" class="static-avatar">
                        
                        <img class="author-profile-image" src="/authors/ryan/avatar_hu2133b973be59ca79693e44e4bc908b85_51876_60x60_fill_q75_box_center.jpg" />
                    </a>
                </li>
            </ul>
            
            <div class="post-card-byline-content">
                
                <a href="https://ryanjan.uk/authors/ryan/">Ryan Kowalewski</a>
                
                <span class="post-card-byline-date">02 Jun 2018 <span class="bull"> &bull; </span>
                    3 min read</span>
            </div>
            
            
        </footer>
    </div>
</article>
        
        <article class="post-card">

    
    
        <a class="post-card-image-link" href="https://ryanjan.uk/storage-drs-and-powercli-part-1-get-vm-overrides/">
            <img class="post-card-image" src="/images/2018/08/override.jpg" loading="lazy" />
        </a>
    

    <div class="post-card-content">
        <a class="post-card-content-link" href="https://ryanjan.uk/storage-drs-and-powercli-part-1-get-vm-overrides/">
            <header class="post-card-header">
                
                
                
                <div class="post-card-primary-tag">powercli</div>
                
                
                <h2 class="post-card-title">Storage DRS and PowerCLI Part 1: Get VM Overrides</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Introduction With Storage DRS (SDRS) enabled datastore clusters, we have many options to configure overrides on a per-VM basis. For example disabling SDRS for a specific VM or forcing SDRS to keep a VMs VMDK files on separate datastores (anti-affinity). However, one thing which has caught out our 2nd line team recently and caused us some SDRS performance issues is that when you manually Storage vMotion (svMotion) one or more VMDK files and pick a specific datastore as the destination, you have to tick a box that disables SDRS for the particular VM.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            
            
            
            
            
            
            <ul class="author-list">
                <li class="author-list-item">
                    
                    <a href="https://ryanjan.uk/authors/ryan/" class="static-avatar">
                        
                        <img class="author-profile-image" src="/authors/ryan/avatar_hu2133b973be59ca79693e44e4bc908b85_51876_60x60_fill_q75_box_center.jpg" />
                    </a>
                </li>
            </ul>
            
            <div class="post-card-byline-content">
                
                <a href="https://ryanjan.uk/authors/ryan/">Ryan Kowalewski</a>
                
                <span class="post-card-byline-date">30 Jul 2018 <span class="bull"> &bull; </span>
                    7 min read</span>
            </div>
            
            
        </footer>
    </div>
</article>
        
        <article class="post-card">

    
    
        <a class="post-card-image-link" href="https://ryanjan.uk/vrops-reports-and-powercli-part-three-a-helper-module/">
            <img class="post-card-image" src="/images/2018/05/vmw-vrealize-operations-fast-facts-2.jpg" loading="lazy" />
        </a>
    

    <div class="post-card-content">
        <a class="post-card-content-link" href="https://ryanjan.uk/vrops-reports-and-powercli-part-three-a-helper-module/">
            <header class="post-card-header">
                
                
                
                <div class="post-card-primary-tag">vrops</div>
                
                
                <h2 class="post-card-title">vROps Reports and PowerCLI Part 3: A Helper Module</h2>
            </header>
            <section class="post-card-excerpt">
                <p>For your reference here is a list of the articles in this mini-series.
vROps Reports and PowerCLI Part 1: Generating Reports vROps Reports and PowerCLI Part 2: Downloading Reports vROps Reports and PowerCLI Part 3: A Helper Module (this article) Introduction If you have been following along with the previous two articles in this series, you should now have a pretty good understanding of how to manipulate the extensionData container via PowerCLI to generate and download reports from vRealize Operations Manager (vROps).</p>
            </section>
        </a>

        <footer class="post-card-meta">
            
            
            
            
            
            
            <ul class="author-list">
                <li class="author-list-item">
                    
                    <a href="https://ryanjan.uk/authors/ryan/" class="static-avatar">
                        
                        <img class="author-profile-image" src="/authors/ryan/avatar_hu2133b973be59ca79693e44e4bc908b85_51876_60x60_fill_q75_box_center.jpg" />
                    </a>
                </li>
            </ul>
            
            <div class="post-card-byline-content">
                
                <a href="https://ryanjan.uk/authors/ryan/">Ryan Kowalewski</a>
                
                <span class="post-card-byline-date">24 Jun 2018 <span class="bull"> &bull; </span>
                    6 min read</span>
            </div>
            
            
        </footer>
    </div>
</article>
        
        
    </div>
</aside>

    </main>
    <footer class="site-footer outer">
    <div class="inner">
        <section class="copyright"><a href="https://ryanjan.uk/"></a> &copy; 2023</section>
        <nav class="site-footer-nav">
            <a href="https://ryanjan.uk/">Latest Posts</a>
            <a href="https://github.com/ryan-jan" target="_blank" rel="noopener">GitHub</a>
            <a href="https://twitter.com/_ryanjan_" target="_blank" rel="noopener">Twitter</a>
        </nav>
    </div>
</footer>
  </div>

  <div id="signup-modal" class="su-modal">
    <div class="su-modal-wrapper">
      <div class="su-modal-container">
        <div class="su-modal-content">
          <span class="su-modal-closeicon">&times;</span>
          <header class="su-modal-signup-header"><img class="su-modal-signup-logo" src="/images/favicon.png"
              alt="RyanJan">
            
          </header>
          <form
            action="https://ryanjan.us1.list-manage.com/subscribe/post?u=60a6496a899e75ef8efe2e2ce&amp;id=9265c5169c"
            method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate"
            target="_blank" novalidate>
            <div class="su-modal-section">
              <section class="su-modal-input-section">
                <div class="su-modal-input-labelcontainer">
                  <label for="input-name" class="su-modal-input-label">Name</label>
                </div>
                <input type="text" value="" name="NAME" class="su-modal-input" id="input-name" placeholder="Joe Bloggs">
              </section>
              <section class="su-modal-input-section">
                <div class="su-modal-input-labelcontainer">
                  <label for="input-email" class="su-modal-input-label">Email</label>
                </div>
                <input type="email" value="" name="EMAIL" class="su-modal-input" id="input-email"
                  placeholder="joe.bloggs@example.com">
              </section>
              
              <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text"
                  name="b_60a6496a899e75ef8efe2e2ce_9265c5169c" tabindex="-1" value=""></div>

              <button class="su-modal-btn su-modal-btn-main su-modal-btn-primary" type="submit"
                style="color: rgb(255, 255, 255); background-color: rgb(0, 0, 0); opacity: 1; pointer-events: auto; width: 100%;">Sign
                up</button>

              <div id="mce-responses" class="clear">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script>
  <script
    type='text/javascript'>(function ($) { window.fnames = new Array(); window.ftypes = new Array(); fnames[1] = 'NAME'; ftypes[1] = 'text'; fnames[0] = 'EMAIL'; ftypes[0] = 'email'; }(jQuery)); var $mcj = jQuery.noConflict(true);</script>

  
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
    </script>
  <script src="/js/casper.js"></script>
  <script>
    $(document).ready(function () {
      
      $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
      });
      
      $(".gh-content").fitVids();
    });
  </script>

  
  <script type="text/javascript" src="/js/prism.js"></script>
  <script type="text/javascript" src="/js/custom/prism-custom.js"></script>
  <script type="text/javascript" src="/js/custom/custom.js"></script>

  
</body>

</html>